<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#2563eb"/>
  <link rel="manifest" href="manifest.webmanifest"/>
  <title data-translate-key="dashboardTitle">SafetyFirst – Admin Dashboard</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body.dashboard .highlight-ticker { display:none !important; }
    .nav-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .lang-switch {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 14px;
      cursor: pointer;
    }
    /* Table alignment fixes */
    .dashboard-table {
      width: 100%;
      border-collapse: collapse;
    }
    .dashboard-table th,
    .dashboard-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: middle;
    }
    .dashboard-table th {
      background-color: #f9fafb;
      font-weight: 600;
      color: #374151;
    }
    .dashboard-table td {
      color: #1f2937;
    }
    .dashboard-table tr:hover {
      background-color: #f9fafb;
    }
    .text-center {
      text-align: center;
    }
    .text-right {
      text-align: right;
    }
  </style>
</head>
<body class="dashboard bg-gray-50 font-sans">
  <nav class="bg-white shadow px-4 py-3 flex items-center justify-between">
    <span class="font-bold text-xl text-blue-600" data-translate-key="dashboardTitle">SafetyFirst Admin</span>
    <div class="nav-controls">
      <!-- Language Switcher -->
      <select id="lang-switch" class="lang-switch">
        <option value="en">English</option>
        <option value="hi">हिन्दी</option>
        <option value="mr">मराठी</option>
        <option value="pa">ਪੰਜਾਬੀ</option>
        <option value="kn">ಕನ್ನಡ</option>
        <option value="ta">தமிழ்</option>
      </select>
      <a href="index1.html" class="text-sm text-blue-600 hover:underline" data-translate-key="backToSite">← Back to Site</a>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-4 grid gap-6">
    <!-- Stats Section -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500" data-translate-key="totalStudents">Total Students</h3>
        <p id="totalStudents" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500" data-translate-key="avgPreparedness">Avg Preparedness</h3>
        <p id="avgScore" class="text-2xl font-bold">0%</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500" data-translate-key="drillsThisMonth">Drills This Month</h3>
        <p id="drillCount" class="text-2xl font-bold">0</p>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="text-sm text-gray-500" data-translate-key="lowestClass">Lowest Class</h3>
        <p id="lowestClass" class="text-2xl font-bold">-</p>
      </div>
    </section>

    <!-- Tables -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded shadow overflow-x-auto">
        <h2 class="p-4 font-bold text-lg" data-translate-key="preparednessScores">Preparedness Scores</h2>
        <table class="dashboard-table">
          <thead>
            <tr>
              <th data-translate-key="name">Name</th>
              <th data-translate-key="class">Class</th>
              <th data-translate-key="score" class="text-center">Score</th>
              <th data-translate-key="lastDrill">Last Drill</th>
            </tr>
          </thead>
          <tbody id="scoreTable"></tbody>
        </table>
      </div>

      <div class="bg-white rounded shadow overflow-x-auto">
        <h2 class="p-4 font-bold text-lg" data-translate-key="drillParticipation">Drill Participation</h2>
        <table class="dashboard-table">
          <thead>
            <tr>
              <th data-translate-key="class">Class</th>
              <th data-translate-key="students" class="text-center">Students</th>
              <th data-translate-key="attended" class="text-center">Attended</th>
              <th class="text-center">%</th>
            </tr>
          </thead>
          <tbody id="drillTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Chart -->
    <section class="bg-white rounded shadow p-4">
      <h2 class="font-bold text-lg mb-2" data-translate-key="classReadinessOverview">Class Readiness Overview</h2>
      <canvas id="readinessChart" height="120"></canvas>
    </section>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDK (same as index.html) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <script>
    // Comprehensive dashboard translations
    const dashboardTranslations = {
      en: {
        dashboardTitle: "SafetyFirst – Admin Dashboard",
        backToSite: "← Back to Site",
        totalStudents: "Total Students",
        avgPreparedness: "Avg Preparedness",
        drillsThisMonth: "Drills This Month",
        lowestClass: "Lowest Class",
        preparednessScores: "Preparedness Scores",
        drillParticipation: "Drill Participation",
        classReadinessOverview: "Class Readiness Overview",
        name: "Name",
        class: "Class",
        score: "Score",
        lastDrill: "Last Drill",
        students: "Students",
        attended: "Attended",
        percentage: "%",
        readinessLabel: "Readiness %"
      },
      hi: {
        dashboardTitle: "सेफ्टीफर्स्ट – व्यवस्थापक डैशबोर्ड",
        backToSite: "← साइट पर वापस जाएं",
        totalStudents: "कुल छात्र",
        avgPreparedness: "औसत तैयारी",
        drillsThisMonth: "इस महीने की ड्रिलें",
        lowestClass: "सबसे कमजोर कक्षा",
        preparednessScores: "तैयारी स्कोर",
        drillParticipation: "ड्रिल भागीदारी",
        classReadinessOverview: "कक्षा तत्परता अवलोकन",
        name: "नाम",
        class: "कक्षा",
        score: "स्कोर",
        lastDrill: "अंतिम ड्रिल",
        students: "छात्र",
        attended: "उपस्थित",
        percentage: "%",
        readinessLabel: "तत्परता %"
      },
      mr: {
        dashboardTitle: "सेफ्टीफर्स्ट – प्रशासक डॅशबोर्ड",
        backToSite: "← साइटवर परत जा",
        totalStudents: "एकूण विद्यार्थी",
        avgPreparedness: "सरासरी तयारी",
        drillsThisMonth: "या महिन्यातील ड्रिल्स",
        lowestClass: "सर्वात कमकुवत वर्ग",
        preparednessScores: "तयारी गुण",
        drillParticipation: "ड्रील सहभाग",
        classReadinessOverview: "वर्ग तयारी आढावा",
        name: "नाव",
        class: "वर्ग",
        score: "गुण",
        lastDrill: "शेवटची ड्रिल",
        students: "विद्यार्थी",
        attended: "उपस्थित",
        percentage: "%",
        readinessLabel: "तयारी %"
      },
      pa: {
        dashboardTitle: "ਸੇਫਟੀਫਸਟ – ਐਡਮਿਨ ਡੈਸ਼ਬੋਰਡ",
        backToSite: "← ਸਾਈਟ ਤੇ ਵਾਪਸ ਜਾਓ",
        totalStudents: "ਕੁੱਲ ਵਿਦਿਆਰਥੀ",
        avgPreparedness: "ਔਸਤ ਤਿਆਰੀ",
        drillsThisMonth: "ਇਸ ਮਹੀਨੇ ਦੀਆਂ ਡ੍ਰਿਲਾਂ",
        lowestClass: "ਸਭ ਤੋਂ ਕਮਜ਼ੋਰ ਕਲਾਸ",
        preparednessScores: "ਤਿਆਰੀ ਦੇ ਅੰਕ",
        drillParticipation: "ਡ੍ਰਿਲ ਭਾਗੀਦਾਰੀ",
        classReadinessOverview: "ਕਲਾਸ ਤਿਆਰੀ ਅਵਲੋਕਨ",
        name: "ਨਾਮ",
        class: "ਕਲਾਸ",
        score: "ਅੰਕ",
        lastDrill: "ਆਖਰੀ ਡ੍ਰਿਲ",
        students: "ਵਿਦਿਆਰਥੀ",
        attended: "ਹਾਜ਼ਰ",
        percentage: "%",
        readinessLabel: "ਤਿਆਰੀ %"
      },
      kn: {
        dashboardTitle: "ಸೇಫ್ಟಿಫಸ್ಟ್ – ನಿರ್ವಾಹಕ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್",
        backToSite: "← ಸೈಟ್‌ಗೆ ಹಿಂತಿರುಗಿ",
        totalStudents: "ಒಟ್ಟು ವಿದ್ಯಾರ್ಥಿಗಳು",
        avgPreparedness: "ಸರಾಸರಿ ಸಿದ್ಧತೆ",
        drillsThisMonth: "ಈ ತಿಂಗಳ ಡ್ರಿಲ್‌ಗಳು",
        lowestClass: "ಕನಿಷ್ಠ ವರ್ಗ",
        preparednessScores: "ಸಿದ್ಧತೆ ಸ್ಕೋರುಗಳು",
        drillParticipation: "ಡ್ರಿಲ್ ಭಾಗವಹಿಸುವಿಕೆ",
        classReadinessOverview: "ವರ್ಗ ಸಿದ್ಧತೆ ಅವಲೋಕನ",
        name: "ಹೆಸರು",
        class: "ವರ್ಗ",
        score: "ಸ್ಕೋರು",
        lastDrill: "ಕೊನೆಯ ಡ್ರಿಲ್",
        students: "ವಿದ್ಯಾರ್ಥಿಗಳು",
        attended: "ಹಾಜರಾದರು",
        percentage: "%",
        readinessLabel: "ಸಿದ್ಧತೆ %"
      },
      ta: {
        dashboardTitle: "சேஃப்டிஃபர்ஸ்ட் – நிர்வாக டாஷ்போர்டு",
        backToSite: "← தளத்திற்கு திரும்பு",
        totalStudents: "மொத்த மாணவர்கள்",
        avgPreparedness: "சராசரி தயார்நிலை",
        drillsThisMonth: "இந்த மாத டிரில்கள்",
        lowestClass: "குறைந்த வகுப்பு",
        preparednessScores: "தயார்நிலை மதிப்பெண்கள்",
        drillParticipation: "டிரில் பங்கேற்பு",
        classReadinessOverview: "வகுப்பு தயார்நிலை கண்ணோட்டம்",
        name: "பெயர்",
        class: "வகுப்பு",
        score: "மதிப்பெண்",
        lastDrill: "கடைசி டிரில்",
        students: "மாணவர்கள்",
        attended: "பங்கேற்றவர்கள்",
        percentage: "%",
        readinessLabel: "தயார்நிலை %"
      }
    };

    // Localized student names data
    const localizedStudentData = {
      en: [
        { name: "Aarav Sharma", class: "8-A", score: 92, lastDrill: "2025-09-01" },
        { name: "Diya Patel", class: "7-B", score: 78, lastDrill: "2025-08-28" },
        { name: "Kabir Singh", class: "9-A", score: 65, lastDrill: "2025-08-30" },
        { name: "Ananya Gupta", class: "8-A", score: 88, lastDrill: "2025-09-01" },
        { name: "Rohan Mehta", class: "7-B", score: 45, lastDrill: "2025-08-25" }
      ],
      hi: [
        { name: "आरव शर्मा", class: "8-अ", score: 92, lastDrill: "2025-09-01" },
        { name: "दिया पटेल", class: "7-बी", score: 78, lastDrill: "2025-08-28" },
        { name: "कबीर सिंह", class: "9-अ", score: 65, lastDrill: "2025-08-30" },
        { name: "अनन्या गुप्ता", class: "8-अ", score: 88, lastDrill: "2025-09-01" },
        { name: "रोहन मेहता", class: "7-बी", score: 45, lastDrill: "2025-08-25" }
      ],
      mr: [
        { name: "आरव शर्मा", class: "8-अ", score: 92, lastDrill: "2025-09-01" },
        { name: "दिया पटेल", class: "7-बी", score: 78, lastDrill: "2025-08-28" },
        { name: "कबीर सिंह", class: "9-अ", score: 65, lastDrill: "2025-08-30" },
        { name: "अनन्या गुप्ता", class: "8-अ", score: 88, lastDrill: "2025-09-01" },
        { name: "रोहन मेहता", class: "7-बी", score: 45, lastDrill: "2025-08-25" }
      ],
      pa: [
        { name: "ਆਰਵ ਸ਼ਰਮਾ", class: "8-ਅ", score: 92, lastDrill: "2025-09-01" },
        { name: "ਦੀਆ ਪਟੇਲ", class: "7-ਬੀ", score: 78, lastDrill: "2025-08-28" },
        { name: "ਕਬੀਰ ਸਿੰਘ", class: "9-ਅ", score: 65, lastDrill: "2025-08-30" },
        { name: "ਅਨਨਿਆ ਗੁਪਤਾ", class: "8-ਅ", score: 88, lastDrill: "2025-09-01" },
        { name: "ਰੋਹਨ ਮੇਹਤਾ", class: "7-ਬੀ", score: 45, lastDrill: "2025-08-25" }
      ],
      kn: [
        { name: "ಆರವ್ ಶರ್ಮಾ", class: "8-ಅ", score: 92, lastDrill: "2025-09-01" },
        { name: "ದಿಯಾ ಪಟೇಲ್", class: "7-ಬಿ", score: 78, lastDrill: "2025-08-28" },
        { name: "ಕಬೀರ್ ಸಿಂಗ್", class: "9-ಅ", score: 65, lastDrill: "2025-08-30" },
        { name: "ಅನನ್ಯಾ ಗುಪ್ತಾ", class: "8-ಅ", score: 88, lastDrill: "2025-09-01" },
        { name: "ರೋಹನ್ ಮೆಹ್ತಾ", class: "7-ಬಿ", score: 45, lastDrill: "2025-08-25" }
      ],
      ta: [
        { name: "ஆரவ் சர்மா", class: "8-அ", score: 92, lastDrill: "2025-09-01" },
        { name: "தியா பட்டேல்", class: "7-பி", score: 78, lastDrill: "2025-08-28" },
        { name: "கபீர் சிங்", class: "9-அ", score: 65, lastDrill: "2025-08-30" },
        { name: "அனன்யா குப்தா", class: "8-அ", score: 88, lastDrill: "2025-09-01" },
        { name: "ரோஹன் மேத்தா", class: "7-பி", score: 45, lastDrill: "2025-08-25" }
      ]
    };

    // Drill data with localized class names
    const localizedDrillData = {
      en: [
        { class: "8-A", total: 42, attended: 39 },
        { class: "7-B", total: 38, attended: 30 },
        { class: "9-A", total: 40, attended: 35 }
      ],
      hi: [
        { class: "8-अ", total: 42, attended: 39 },
        { class: "7-बी", total: 38, attended: 30 },
        { class: "9-अ", total: 40, attended: 35 }
      ],
      mr: [
        { class: "8-अ", total: 42, attended: 39 },
        { class: "7-बी", total: 38, attended: 30 },
        { class: "9-अ", total: 40, attended: 35 }
      ],
      pa: [
        { class: "8-ਅ", total: 42, attended: 39 },
        { class: "7-ਬੀ", total: 38, attended: 30 },
        { class: "9-ਅ", total: 40, attended: 35 }
      ],
      kn: [
        { class: "8-ಅ", total: 42, attended: 39 },
        { class: "7-ಬಿ", total: 38, attended: 30 },
        { class: "9-ಅ", total: 40, attended: 35 }
      ],
      ta: [
        { class: "8-அ", total: 42, attended: 39 },
        { class: "7-பி", total: 38, attended: 30 },
        { class: "9-அ", total: 40, attended: 35 }
      ]
    };

    // Translation function
    function translateDashboard(lang) {
      const translations = dashboardTranslations[lang] || dashboardTranslations.en;
      
      document.querySelectorAll('[data-translate-key]').forEach(element => {
        const key = element.getAttribute('data-translate-key');
        if (translations[key]) {
          element.textContent = translations[key];
        }
      });

      // Update chart label
      const chart = Chart.getChart("readinessChart");
      if (chart) {
        chart.data.datasets[0].label = translations.readinessLabel || 'Readiness %';
        chart.update();
      }
    }

    // Language change handler
    function changeLanguage() {
      const selectedLang = document.getElementById("lang-switch").value;
      localStorage.setItem("selectedLanguage", selectedLang);
      translateDashboard(selectedLang);
      renderData(selectedLang); // Re-render with localized data
    }

    // Render data with proper alignment and localization
    function renderData(lang) {
      const students = localizedStudentData[lang] || localizedStudentData.en;
      const drills = localizedDrillData[lang] || localizedDrillData.en;
      const translations = dashboardTranslations[lang] || dashboardTranslations.en;
      
      // Update statistics
      document.getElementById('totalStudents').textContent = students.length;
      document.getElementById('avgScore').textContent = Math.round(students.reduce((s,st)=>s+st.score,0)/students.length) + '%';
      document.getElementById('drillCount').textContent = drills.reduce((s,d)=>s+d.attended,0);
      document.getElementById('lowestClass').textContent = drills.reduce((min,d)=>d.attended/d.total < min.ratio ? {ratio:d.attended/d.total,cls:d.class} : min,{ratio:1}).cls;

      // Render student table with proper alignment
      document.getElementById('scoreTable').innerHTML = students.map(s=>
        `<tr>
          <td style="padding: 12px 16px; text-align: left;">${s.name}</td>
          <td style="padding: 12px 16px; text-align: left;">${s.class}</td>
          <td style="padding: 12px 16px; text-align: center; font-weight: 600;">${s.score}%</td>
          <td style="padding: 12px 16px; text-align: left;">${s.lastDrill}</td>
        </tr>`
      ).join('');
      
      // Render drill table with proper alignment
      document.getElementById('drillTable').innerHTML = drills.map(d=>
        `<tr>
          <td style="padding: 12px 16px; text-align: left;">${d.class}</td>
          <td style="padding: 12px 16px; text-align: center;">${d.total}</td>
          <td style="padding: 12px 16px; text-align: center;">${d.attended}</td>
          <td style="padding: 12px 16px; text-align: center; font-weight: 600;">${Math.round(d.attended/d.total*100)}%</td>
        </tr>`
      ).join('');

      // Clear existing chart and create new one with translated label
      const existingChart = Chart.getChart("readinessChart");
      if (existingChart) {
        existingChart.destroy();
      }

      new Chart(document.getElementById('readinessChart'), {
        type:'bar',
        data:{
          labels: drills.map(d=>d.class),
          datasets:[{
            label: translations.readinessLabel || 'Readiness %',
            data: drills.map(d=>Math.round(d.attended/d.total*100)),
            backgroundColor:'#3b82f6',
            borderColor: '#2563eb',
            borderWidth: 1
          }]
        },
        options:{
          responsive: true,
          maintainAspectRatio: false,
          scales:{
            y:{
              beginAtZero:true,
              max:100,
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          }
        }
      });
    }

    // Initialize language and render
    document.addEventListener('DOMContentLoaded', () => {
      const savedLang = localStorage.getItem("selectedLanguage") || "en";
      document.getElementById("lang-switch").value = savedLang;
      translateDashboard(savedLang);
      renderData(savedLang);
      
      // Set up language change listener
      document.getElementById("lang-switch").addEventListener("change", changeLanguage);
    });
  </script>
  <script src="pwa.js" defer></script>
</body>
</html>